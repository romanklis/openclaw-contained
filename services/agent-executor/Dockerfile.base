# Base OpenClaw Agent Executor Image
# This builds from source and extracts only the agent runtime components

FROM node:22-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    python3 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN npm install -g pnpm

# Clone and build OpenClaw
WORKDIR /build
RUN git clone --depth 1 https://github.com/openclaw/openclaw.git
WORKDIR /build/openclaw
RUN pnpm install && pnpm build

# Final runtime image
FROM node:22-slim

# Install Python for wrapper integration
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Create Python virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python dependencies
RUN pip install --no-cache-dir httpx

# Install pnpm in runtime
RUN npm install -g pnpm

# Copy OpenClaw build from builder
COPY --from=builder /build/openclaw /opt/openclaw

# Create workspace directory (using existing node user which is UID 1000)
RUN mkdir -p /workspace && \
    chown node:node /workspace

# Copy wrapper script
COPY openclaw-wrapper.py /app/wrapper.py

WORKDIR /workspace
USER node

ENV PATH="/opt/openclaw/dist:$PATH"
ENV NODE_PATH="/opt/openclaw/node_modules"

ENTRYPOINT ["python3", "/app/wrapper.py"]
